const { query } = require('../config/database');  // Change this line
const PDFDocument = require('pdfkit');

class MainController {
  // Generate document numbers
  generateDocNumber(prefix) {
    const date = new Date();
    const timestamp = `${date.getFullYear().toString().slice(2)}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `${prefix}-${timestamp}-${random}`;
  }

  // Calculate totals
  calculateTotals(items, taxRate = 16) {
    const subtotal = items.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0);
    const tax_amount = (subtotal * taxRate) / 100;
    const total = subtotal + tax_amount;
    return { subtotal, tax_amount, total, tax_rate: taxRate };
  }

  // CLIENTS
  async createClient(req, res) {
    try {
      const { name, email, phone, address, company_name } = req.body;
      const result = await query(
        'INSERT INTO clients (name, email, phone, address, company_name) VALUES ($1, $2, $3, $4, $5) RETURNING *',
        [name, email, phone, address, company_name]
      );
      res.json({ success: true, data: result.rows[0] });
    } catch (error) {
      res.status(500).json({ error: 'Failed to create client' });
    }
  }

  async getClients(req, res) {
    try {
      const result = await query('SELECT * FROM clients ORDER BY created_at DESC');
      res.json({ success: true, data: result.rows });
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch clients' });
    }
  }

  // INVOICES
  async createInvoice(req, res) {
    try {
      const { client_id, issue_date, due_date, items, notes } = req.body;
      const totals = this.calculateTotals(items);
      const invoice_number = this.generateDocNumber('INV');

      const result = await query(
        `INSERT INTO invoices (invoice_number, client_id, issue_date, due_date, items, subtotal, tax_rate, tax_amount, total, notes) 
         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING *`,
        [invoice_number, client_id, issue_date, due_date, JSON.stringify(items),
         totals.subtotal, totals.tax_rate, totals.tax_amount, totals.total, notes]
      );

      res.json({ success: true, data: result.rows[0] });
    } catch (error) {
      res.status(500).json({ error: 'Failed to create invoice' });
    }
  }

  async getInvoices(req, res) {
    try {
      const result = await query(`
        SELECT i.*, c.name as client_name, c.company_name 
        FROM invoices i 
        LEFT JOIN clients c ON i.client_id = c.id 
        ORDER BY i.created_at DESC
      `);
      res.json({ success: true, data: result.rows });
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch invoices' });
    }
  }

  // QUOTATIONS
  async createQuotation(req, res) {
    try {
      const { client_id, issue_date, valid_until, items, notes } = req.body;
      const totals = this.calculateTotals(items);
      const quote_number = this.generateDocNumber('QUO');

      const result = await query(
        `INSERT INTO quotations (quote_number, client_id, issue_date, valid_until, items, subtotal, tax_rate, tax_amount, total, notes) 
         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING *`,
        [quote_number, client_id, issue_date, valid_until, JSON.stringify(items),
         totals.subtotal, totals.tax_rate, totals.tax_amount, totals.total, notes]
      );

      res.json({ success: true, data: result.rows[0] });
    } catch (error) {
      res.status(500).json({ error: 'Failed to create quotation' });
    }
  }

  async getQuotations(req, res) {
    try {
      const result = await query(`
        SELECT q.*, c.name as client_name, c.company_name 
        FROM quotations q 
        LEFT JOIN clients c ON q.client_id = c.id 
        ORDER BY q.created_at DESC
      `);
      res.json({ success: true, data: result.rows });
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch quotations' });
    }
  }

  // PDF GENERATION
  async generateInvoicePDF(req, res) {
    try {
      const { id } = req.params;
      const result = await query(`
        SELECT i.*, c.name as client_name, c.email, c.phone, c.address, c.company_name as client_company
        FROM invoices i LEFT JOIN clients c ON i.client_id = c.id WHERE i.id = $1
      `, [id]);

      if (result.rows.length === 0) return res.status(404).json({ error: 'Not found' });

      const doc = new PDFDocument();
      const invoice = result.rows[0];
      
      res.setHeader('Content-Type', 'application/pdf');
      res.setHeader('Content-Disposition', `attachment; filename=invoice-${invoice.invoice_number}.pdf`);
      doc.pipe(res);

      // PDF Content
      doc.fontSize(20).text('INVOICE', 50, 50);
      doc.fontSize(10)
         .text(`Invoice: ${invoice.invoice_number}`, 50, 80)
         .text(`Date: ${new Date(invoice.issue_date).toLocaleDateString()}`, 50, 95)
         .text(`Due: ${new Date(invoice.due_date).toLocaleDateString()}`, 50, 110);

      // Company Info
      doc.text('AksagenSet Services', 350, 50)
         .text('Nairobi, Kenya', 350, 65)
         .text('+254 XXX XXX XXX', 350, 80)
         .text('info@aksagensetservices.co.ke', 350, 95);

      // Client Info
      doc.text('Bill To:', 50, 140)
         .text(invoice.client_company || invoice.client_name, 50, 155)
         .text(invoice.client_address, 50, 170);

      // Items Table
      let y = 220;
      doc.text('Description', 50, y).text('Qty', 300, y).text('Price', 350, y).text('Amount', 420, y);
      y += 20;

      JSON.parse(invoice.items).forEach(item => {
        doc.text(item.description.substring(0, 40), 50, y)
           .text(item.quantity.toString(), 300, y)
           .text(`KSh ${item.unit_price.toFixed(2)}`, 350, y)
           .text(`KSh ${(item.quantity * item.unit_price).toFixed(2)}`, 420, y);
        y += 20;
      });

      // Totals
      y += 20;
      doc.text(`Subtotal: KSh ${invoice.subtotal.toFixed(2)}`, 350, y);
      y += 15;
      doc.text(`Tax (${invoice.tax_rate}%): KSh ${invoice.tax_amount.toFixed(2)}`, 350, y);
      y += 15;
      doc.text(`Total: KSh ${invoice.total.toFixed(2)}`, 350, y);
      y += 10;
      doc.rect(340, y-5, 200, 1).stroke();

      doc.end();
    } catch (error) {
      res.status(500).json({ error: 'PDF generation failed' });
    }
  }

  // Similar method for quotations PDF...
  async generateQuotationPDF(req, res) {
    // Implementation similar to invoice PDF
    res.json({ message: 'Quotation PDF endpoint' });
  }
}

module.exports = new MainController();